From 4472def365a7431d05f19e4dae3a7cc8ef2310e5 Mon Sep 17 00:00:00 2001
From: Brian C. Lane <bcl@redhat.com>
Date: Wed, 22 Jun 2011 19:14:42 -0700
Subject: [PATCH] Add tests for snap fix

---
 tests/Makefile.in            |    6 +++++
 tests/t9022-one-unit-snap.sh |   48 ++++++++++++++++++++++++++++++++++++++++++
 tests/t9023-value-lt-one.sh  |   38 +++++++++++++++++++++++++++++++++
 3 files changed, 92 insertions(+), 0 deletions(-)
 create mode 100644 tests/t9022-one-unit-snap.sh
 create mode 100644 tests/t9023-value-lt-one.sh

diff --git a/tests/Makefile.in b/tests/Makefile.in
index 6df5215..d2d2a9e 100644
--- a/tests/Makefile.in
+++ b/tests/Makefile.in
@@ -880,6 +880,8 @@ TESTS = \
   t9010-big-sector.sh \
   t9020-alignment.sh \
   t9021-maxima.sh \
+  t9022-one-unit-snap.sh \
+  t9023-value-lt-one.sh \
   t9030-align-check.sh
 
 EXTRA_DIST = \
@@ -1309,6 +1311,10 @@ t9020-alignment.sh.log: t9020-alignment.sh
 	@p='t9020-alignment.sh'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
 t9021-maxima.sh.log: t9021-maxima.sh
 	@p='t9021-maxima.sh'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
+t9022-one-unit-snap.sh.log: t9022-one-unit-snap.sh
+	@p='t9022-one-unit-snap.sh'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
+t9023-value-lt-one.sh.log: t9023-value-lt-one.sh
+	@p='t9023-value-lt-one.sh'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
 t9030-align-check.sh.log: t9030-align-check.sh
 	@p='t9030-align-check.sh'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
 .test.log:
diff --git a/tests/t9022-one-unit-snap.sh b/tests/t9022-one-unit-snap.sh
new file mode 100644
index 0000000..eaaaa4a
--- /dev/null
+++ b/tests/t9022-one-unit-snap.sh
@@ -0,0 +1,48 @@
+#!/bin/sh
+# Confirm that specifying 1 unit snaps to the correct value
+
+# Copyright (C) 2011 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+if test "$VERBOSE" = yes; then
+  set -x
+  parted --version
+fi
+
+: ${srcdir=.}
+. $srcdir/t-lib.sh
+
+ss=$sector_size_
+n_sectors=3000
+dev=dev-file
+
+# Create an example of what the result should look like
+# start should be at 1 sector.
+dd if=/dev/null of=$dev bs=$ss seek=$n_sectors || fail=1
+parted --align=none -s $dev mklabel msdos mkpart pri 1s $((1000*1000))B \
+    > err 2>&1 || fail=1
+compare err /dev/null || fail=1
+parted -m -s $dev u s p > exp || fail=1
+
+rm $dev
+dd if=/dev/null of=$dev bs=$ss seek=$n_sectors || fail=1
+parted --align=none -s $dev mklabel msdos mkpart pri 0 1MB \
+    > err 2>&1 || fail=1
+compare err /dev/null || fail=1
+parted -m -s $dev u s p > out || fail=1
+
+compare out exp || fail=1
+
+Exit $fail
diff --git a/tests/t9023-value-lt-one.sh b/tests/t9023-value-lt-one.sh
new file mode 100644
index 0000000..349e65a
--- /dev/null
+++ b/tests/t9023-value-lt-one.sh
@@ -0,0 +1,38 @@
+#!/bin/sh
+# Confirm that a value between 0 and 1 throws an error
+
+# Copyright (C) 2011 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+if test "$VERBOSE" = yes; then
+  set -x
+  parted --version
+fi
+
+: ${srcdir=.}
+. $srcdir/t-lib.sh
+
+ss=$sector_size_
+n_sectors=3000
+dev=dev-file
+
+echo 'Error: Use a smaller unit instead of a value < 1' > exp
+
+dd if=/dev/null of=$dev bs=$ss seek=$n_sectors || fail=1
+parted --align=none -s $dev mklabel msdos mkpart pri 0 0.5MB \
+    > err 2>&1
+compare err exp || fail=1
+
+Exit $fail
-- 
1.7.4.4

